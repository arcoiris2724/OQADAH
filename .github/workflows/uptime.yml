name: Uptime Ping

on:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Check home
        run: |
          set -e
          curl -fsS --max-time 10 https://oqadah.com >/dev/null
          echo "Home OK"
      - name: Check SPA fallback
        run: |
          set -e
          status_line=$(curl -Is --max-time 10 https://oqadah.com/not-a-real-page | head -n 1)
          echo "$status_line"
          echo "$status_line" | grep -q "200"
          echo "SPA OK"
      - name: Slack notify on failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"Uptime Ping failed on oqadah.com"}' \
            "$SLACK_WEBHOOK_URL"
    - name: Check security headers
      run: |
        set -e
        headers=$(curl -Is --max-time 10 https://oqadah.com | grep -E "Strict-Transport-Security|X-Content-Type-Options|Referrer-Policy")
        echo "$headers" | grep "Strict-Transport-Security"
        echo "$headers" | grep "X-Content-Type-Options"
        echo "$headers" | grep "Referrer-Policy"
        echo "Security headers OK"
